<% @title = 'Attendance Tracking' %>
<div class="page-header">
  <h1>
    <%= @title %>
    <%= link_to "Create Seminar", new_seminar_path, class: 'btn btn-mini btn-primary' %>
    <%= link_to "View All", seminars_path, class: 'btn btn-mini' %>
  </h1>
</div>

<% applicants = Applicant.current.where(enrolled: true) %>
<% applicants = applicants.where(status: params[:status]) unless params[:status].blank? %>

<% year = params[:year] || Date.today.year %>

<% year_seminars = Seminar.current.date_after(Date.parse("#{year}-01-01")).date_before(Date.parse("#{year}-12-31")) %>

<%= form_tag attendance_seminars_path(status: params[:status]), method: :get, class: 'form-inline' do %>
  <%= select_tag :year, options_for_select(Seminar.current.pluck(:presentation_date).collect{|i|i ? i.year : nil}.uniq.compact.sort.collect{|i| [i,i]}, year) %>
  <%= select_tag :status, options_for_select([['All Trainees', nil]] + Applicant::STATUS, params[:status]) %>
  <%= submit_tag 'Filter', class: 'btn' %>
<% end %>

<table class="table table-striped table-condensed">
  <thead>
    <tr>
      <th></th>
      <% year_seminars.group_by{|s| s.category}.each do |category, seminars| %>
        <th colspan="<%= seminars.size %>">
          <%= category %>
        </th>
      <% end %>
    </tr>
    <tr>
      <th>
        Trainees <%= "(#{params[:status]})" unless params[:status].blank? %>
      </th>
      <% year_seminars.group_by{|s| s.category}.each do |category, seminars| %>
        <% seminars.sort_by{ |s| s.presentation_date }.each do |seminar| %>
          <th style="white-space:nowrap">
            <span rel="tooltip" title="<%= [(seminar.presentation_date ? seminar.presentation_date.strftime("%Y-%m-%d") : ''), seminar.presentation_title, seminar.presenter].select{|i| not i.blank?}.join(' - ') %>">
              <%= link_to seminar.presentation_date.strftime("%-m/%-d"), seminar if seminar.presentation_date %>
            </span>
          </th>
        <% end %>
      <% end %>
    </tr>
  </thead>
  <tfoot>
    <tr>
      <th style="font:inherit">
        Total
      </th>
      <% year_seminars.group_by{|s| s.category}.each do |category, seminars| %>
        <% seminars.sort_by{ |s| s.presentation_date }.each do |seminar| %>
          <th style="white-space:nowrap">
            <%= seminar.applicants.where(id: applicants.pluck(:id)).count %>
          </th>
        <% end %>
      <% end %>
    </tr>
  </tfoot>
  <tbody>
    <% applicants.order('last_name, first_name').each do |applicant| %>
      <tr>
        <td><%= link_to applicant.reverse_name, applicant %></td>
        <% year_seminars.group_by{|s| s.category}.each do |category, seminars| %>
          <% seminars.sort_by{ |s| s.presentation_date }.each do |seminar| %>
            <td id="applicant_<%= applicant.id %>_seminar_<%= seminar.id %>_attendance">
              <%= render partial: 'attendance', locals: { applicant: applicant, seminar: seminar } %>
            </td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </tbody>

</table>
